<div class="container-fluid">
    <!-- HEADER -->
    <div class="header-container header-actions">
        <h1>Orders</h1>

        <!-- Standalone buttons (screen-level) -->
        <div class="actions">
            <button mat-stroked-button (click)="refreshMessagesOnce()">
                Refresh messages
            </button>

            <button mat-raised-button color="primary" *ngIf="!(messagesRunning$ | async)" (click)="startMessagesAuto()">
                Auto (5s)
            </button>

            <button mat-raised-button color="warn" *ngIf="(messagesRunning$ | async)" (click)="stopMessagesAuto()">
                Stop auto
            </button>
        </div>
    </div>
    <div class="filter-container">
    </div>

    <div class="table-container">
        <!-- <ng-template #desktopView> -->
        <!-- Vista escritorio tipo tabla -->
        <table mat-table [dataSource]="dataSource" class="mat-elevation-z8 mat-table" matSort>
            <ng-container matColumnDef="Customer Name">
                <th mat-header-cell *matHeaderCellDef> Customer Name </th>
                <td mat-cell *matCellDef="let p"> {{ p.name }} </td>
            </ng-container>

            <ng-container matColumnDef="Customer Lastname">
                <th mat-header-cell *matHeaderCellDef> Customer Lastname </th>
                <td mat-cell *matCellDef="let p"> {{ p.lastName }} </td>
            </ng-container>

            <ng-container matColumnDef="Make">
                <th mat-header-cell *matHeaderCellDef> Make </th>
                <td mat-cell *matCellDef="let p"> {{ p.vehiculeMakeName }} </td>
            </ng-container>

            <ng-container matColumnDef="Model">
                <th mat-header-cell *matHeaderCellDef> Model </th>
                <td mat-cell *matCellDef="let p"> {{ p.vehiculeModelName }} </td>
            </ng-container>

            <ng-container matColumnDef="Year">
                <th mat-header-cell *matHeaderCellDef> Year </th>
                <td mat-cell *matCellDef="let p"> {{ p.vehiculeYear }} </td>
            </ng-container>

            <ng-container matColumnDef="BodyStyle">
                <th mat-header-cell *matHeaderCellDef> Body Style </th>
                <td mat-cell *matCellDef="let p"> {{ p.vehiculeBodyStyleName }} </td>
            </ng-container>

            <ng-container matColumnDef="NumberOfCylinders">
                <th mat-header-cell *matHeaderCellDef> Number Of Cylinders </th>
                <td mat-cell *matCellDef="let p"> {{ p.vehiculeEngineNumberOfCylinders }} </td>
            </ng-container>

            <ng-container matColumnDef="Transmission">
                <th mat-header-cell *matHeaderCellDef> Transmission </th>
                <td mat-cell *matCellDef="let p"> {{ p.vehiculeTransmissionName }} </td>
            </ng-container>

            <!-- <ng-container matColumnDef="Tracción">
                <th mat-header-cell *matHeaderCellDef> Tracción </th>
                <td mat-cell *matCellDef="let p"> {{ p.vehiculeDriveTypeName }} </td>
            </ng-container> -->

            <!-- <ng-container matColumnDef="Tipo de Combustible">
                <th mat-header-cell *matHeaderCellDef> Tipo de Combustible </th>
                <td mat-cell *matCellDef="let p"> {{ p.vehiculeFuelTypeName }} </td>
            </ng-container> -->



            <ng-container matColumnDef="Picture">
                <th mat-header-cell *matHeaderCellDef> Picture </th>
                <td mat-cell *matCellDef="let p">
                    <img [src]="p.foto" alt="Foto" class="thumbnail-img" />
                </td>
            </ng-container>

            <ng-container matColumnDef="Messages">
                <th mat-header-cell *matHeaderCellDef> Messages </th>

                <td mat-cell *matCellDef="let p">
                    <div class="msg-cell" *ngIf="p.messagesCount > 0; else noMsg" (click)="openMessagesPanel(p)">

                        <!-- Header row -->
                        <div class="msg-header">

                            <!-- Badge -->
                            <span class="msg-badge" [class.live]="messagesRunning$ | async">
                                {{ p.messagesCount }}
                            </span>

                            <!-- Unread dot (optional future feature) -->
                            <span *ngIf="p.hasUnread" class="msg-dot"></span>

                            <!-- Time -->
                            <span class="msg-time">
                                {{ p.lastMessageAt | date:'shortTime' }}
                            </span>

                        </div>

                        <!-- Preview -->
                        <div class="msg-preview" [title]="p.lastMessageText">
                            <mat-icon fontIcon="chat_bubble_outline" class="msg-icon"></mat-icon>
                            {{ p.lastMessageText }}
                        </div>

                    </div>

                    <!-- Empty state -->
                    <ng-template #noMsg>
                        <div class="msg-empty">
                            <mat-icon fontIcon="chat_bubble_outline"></mat-icon>
                            No messages
                        </div>
                    </ng-template>
                </td>
            </ng-container>

            <!-- <ng-container matColumnDef="Creado">
                <th mat-header-cell *matHeaderCellDef> Creado </th>
                <td mat-cell *matCellDef="let p"> {{ p.createdAt | excludeDefaultDate }} </td>
            </ng-container>

            <ng-container matColumnDef="Creado Por">
                <th mat-header-cell *matHeaderCellDef> Creado Por </th>
                <td mat-cell *matCellDef="let p"> {{ p.createdBy }} </td>
            </ng-container>

            <ng-container matColumnDef="Modificado">
                <th mat-header-cell *matHeaderCellDef> Modificado </th>
                <td mat-cell *matCellDef="let p"> {{ p.modifiedAt | excludeDefaultDate }} </td>
            </ng-container>

            <ng-container matColumnDef="Modificado Por">
                <th mat-header-cell *matHeaderCellDef> Modificado Por </th>
                <td mat-cell *matCellDef="let p"> {{ p.modifiedBy }} </td>
            </ng-container> -->

            <ng-container matColumnDef="Active">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Active</th>
                <td mat-cell *matCellDef="let element">
                    <div class="justify">
                        <mat-icon *ngIf="element.isAllow" fontIcon="check_circle" class="green">
                        </mat-icon>
                        <mat-icon *ngIf="!element.isAllow" fontIcon="radio_button_unchecked" class="neutro">
                        </mat-icon>
                    </div>
                </td>
            </ng-container>

            <ng-container matColumnDef="Actions">
                <th mat-header-cell *matHeaderCellDef class="center-th">Actions</th>
                <td mat-cell *matCellDef="let element">
                    <div class="justify">

                        <mat-icon fontIcon="edit" class="selector" title="Editar orden" (click)="update(element)">
                        </mat-icon>


                        <mat-icon fontIcon="published_with_changes" class="selector green" title="Change State"
                            (click)="changeIsActiveState(element)">
                        </mat-icon>


                        <mat-icon *ngIf="!element.isDeleted" fontIcon="delete" class="selector red" title="Delete Order"
                            (click)="delete(element)">
                        </mat-icon>

                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns_en"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns_en;"
                [ngClass]="{ 'selected-row': row === selectedRow }" (click)="onRowClick(row)"></tr>
        </table>
        <!-- </ng-template> -->
    </div>
    <div *ngIf="totalRecords == 0" class="no-data">Sin datos</div>
    <!-- #region Paginator y custom style -->
    <mat-paginator [length]="totalRecords" [pageSize]="rowsPerPage" (page)="pageChanged($event)" class="d-none">
    </mat-paginator>

    <app-custom-paginator [totalRecords]="totalRecords" [currentPage]="currentPage" [rowsPerPageList]="rowsPerPageList"
        [rowsPerPage]="rowsPerPage" (fetchList)="fetchList($event)"
        (changeRowsNumber)="triggerPaginatorPageChangedEvent($event)" class="custom-paginator-style">
    </app-custom-paginator>
    <!-- #endregion -->
</div>